head	1.6;
access;
symbols
	stable-branch:1.1
	rel-7-10-0:1.5
	rel-7-8-4:1.4
	rel-7-8-2:1.4
	rel-7-8-0:1.4
	trimnurbs-branch:1.4.0.2
	help:1.4
	temp_tag:1.3
	bobWinPort-20051223-freeze:1.2
	postmerge-20051223-bobWinPort:1.3
	premerge-20051223-bobWinPort:1.3
	rel-7-6-6:1.3
	rel-7-6-4:1.3
	rel-7-6-2:1.2
	rel-7-6-branch:1.2.0.6
	rel-7-6-0:1.2
	rel-7-4-2:1.2
	rel-7-4-branch:1.2.0.4
	bobWinPort:1.2.0.2
	rel-7-4-0:1.2
	rel-7-2-6:1.1
	rel-7-2-4:1.1
	rel-7-2-2:1.1;
locks; strict;
comment	@# @;


1.6
date	2007.07.31.04.50.19;	author brlcad;	state dead;
branches;
next	1.5;

1.5
date	2007.01.20.14.36.40;	author brlcad;	state Exp;
branches;
next	1.4;

1.4
date	2006.01.18.06.46.10;	author brlcad;	state Exp;
branches;
next	1.3;

1.3
date	2005.10.23.04.26.14;	author brlcad;	state Exp;
branches;
next	1.2;

1.2
date	2005.07.10.21.06.46;	author brlcad;	state Exp;
branches
	1.2.6.1;
next	1.1;

1.1
date	2005.03.18.23.24.32;	author brlcad;	state Exp;
branches;
next	;

1.2.6.1
date	2005.11.13.13.46.10;	author brlcad;	state Exp;
branches;
next	;


desc
@@


1.6
log
@autogen.sh no longer creates .backup files in an aux directory, so there's nothing for us to automatically recover from.  this means subsequent clobbering automakes may blow away our files, but there's not much we can do about it.
@
text
@#                     R E S T O R E . M 4
# BRL-CAD
#
# Copyright (c) 2005-2007 United States Government as represented by
# the U.S. Army Research Laboratory.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
# 1. Redistributions of source code must retain the above copyright
# notice, this list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above
# copyright notice, this list of conditions and the following
# disclaimer in the documentation and/or other materials provided
# with the distribution.
#
# 3. The name of the author may not be used to endorse or promote
# products derived from this software without specific prior written
# permission.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS
# OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
# DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
# GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
###
#
# BC_RESTORE_CLOBBERED
#
# restores a file that has been backed up to a directory if the contents
# have changed.  if the files have Revision numbers, those are used to
# determine which file is newer.
#
# an automake bug in older versions will clobber existing COPYING and
# INSTALL files, so those are common files that need to be restored.
#
###

AC_DEFUN([BC_RESTORE_CLOBBERED], [

files_to_check="ifelse([$1], , [], [$1])"
backup_dir="ifelse([$2], , [.], [$2])"

for file in $files_to_check ; do
	curr="$srcdir/$file"
	back="$srcdir/${backup_dir}/${file}.backup"
	if ! test -f "$back" ; then
		continue
	fi

	AC_MSG_CHECKING([whether ${file} needs to be restored])
	current=""
	backup=""
	if test -f "$curr" ; then
		if test -f "$back" ; then
			current="`cat $curr`"
			backup="`cat $back`"
			if test "x$current" = "x$backup" ; then
				# contents match
				AC_MSG_RESULT([no])
			else
				current_rev=`grep '$Revision' "$curr" | awk '{print $[2]}' | sed 's/\.//g'`
				if test "x$current_rev" = "x" ; then
					current_rev=0
				fi
				backup_rev=`grep '$Revision' "$back" | awk '{print $[2]}' | sed 's/\.//g'`
				if test "x$backup_rev" = "x" ; then
					backup_rev=0
				fi

				if test "$current_rev" -gt "$backup_rev" ; then
					AC_MSG_RESULT([no, saving backup])
					# new version in/from cvs.. back it up
					cp -pr "$curr" "$back"
				else
					AC_MSG_RESULT([yes])
					cp -pr "$back" "$curr"
				fi
			fi
		else
			AC_MSG_RESULT([no, backup missing])
		fi
	else
		# missing current
		if test -f "$back" ; then
			AC_MSG_RESULT([yes, missing])
			cp -pr "$back" "$curr"
		else
			AC_MSG_RESULT([yes, but no backup])
		fi
	fi
done

])

# Local Variables:
# mode: m4
# tab-width: 8
# standard-indent: 4
# indent-tabs-mode: t
# End:
# ex: shiftwidth=4 tabstop=8
@


1.5
log
@update copyright to 2007
@
text
@@


1.4
log
@update copyright to 2006
@
text
@d4 1
a4 1
# Copyright (c) 2005-2006 United States Government as represented by
@


1.3
log
@trailing ws
@
text
@d4 1
a4 1
# Copyright (C) 2005 United States Government as represented by
@


1.2
log
@restoration check still failing to avoid getting clobbered with the generic docs -- improve the restoration check by minimizing the cases that result in a backup restore and the cases that cause a backup to get saved.
@
text
@d14 1
a14 1
# 2. Redistributions in binary form must reproduce the above 
d47 1
a47 1
	
d78 1
a78 1
				fi		
@


1.2.6.1
log
@merge changes from HEAD aka rel-7-6-4 to the rel-7-6-branch just in case someone peeks a gander or tries to continue/build the branch
@
text
@d14 1
a14 1
# 2. Redistributions in binary form must reproduce the above
d47 1
a47 1

d78 1
a78 1
				fi
@


1.1
log
@separate out the tests for a clobbered INSTALL/COPYING file into their own m4/restore.m4 using a BC_RESTORE_CLOBBERED macro function.  it takes two optional arguments for the files to check and the directory off of the srcdir to find them in.  if the files have a revision id, those take precedence over a content difference in the backup.
@
text
@d63 16
a78 14
	if test -f "$srcdir/$file" ; then
		current="`cat $curr`"
		backup="`cat $back`"
		if test "x$current" = "x$backup" ; then
			AC_MSG_RESULT([no])
		else
			current_rev=`grep '$Revision' "$curr" | awk '{print $[2]}' | sed 's/\.//g'`
			if test "x$current_rev" = "x" ; then
				current_rev=0
			fi
			backup_rev=`grep '$Revision' "$back" | awk '{print $[2]}' | sed 's/\.//g'`
			if test "x$backup_rev" = "x" ; then
				backup_rev=0
			fi
d80 8
a87 7
			if test "$current_rev" -ge "$backup_rev" ; then
				AC_MSG_RESULT([no, saving backup])
				# new version from cvs.. back it up
				cp -pr "$curr" "$back"
			else
				AC_MSG_RESULT([yes])
				cp -pr "$back" "$curr"
d89 2
d93 7
a99 2
		AC_MSG_RESULT([yes, missing])
		cp -pr "$back" "$curr"
@

