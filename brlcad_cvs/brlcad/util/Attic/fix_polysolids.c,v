head	1.7;
access;
symbols
	ansi-20040405-merged:1.4.4.1
	postmerge-20040405-ansi:1.5
	premerge-20040404-ansi:1.5
	postmerge-autoconf:1.5
	autoconf-freeze:1.4.12.2
	premerge-autoconf:1.5
	postmerge-20040315-windows:1.5
	premerge-20040315-windows:1.5
	windows-20040315-freeze:1.4.6.1
	autoconf-20031203:1.4
	autoconf-20031202:1.4
	autoconf-branch:1.4.0.12
	phong-branch:1.4.0.10
	photonmap-branch:1.4.0.8
	rel-6-1-DP:1.4
	windows-branch:1.4.0.6
	rel-6-0-2:1.4
	ansi-branch:1.4.0.4
	rel-6-0-1-branch:1.4.0.2
	hartley-6-0-post:1.4
	hartley-6-0-pre:1.4
	rel-6-0-1:1.4
	rel-6-0:1.4
	rel-5-4:1.1
	offsite-5-3-pre:1.3
	rel-5-3:1.1
	rel-5-2:1.1
	rel-5-1-branch:1.1.0.2
	rel-5-1:1.1
	rel-5-0:1.1
	rel-5-0-beta:1.1
	rel-4-5:1.1
	ctj-4-5-post:1.1
	ctj-4-5-pre:1.1;
locks; strict;
comment	@ * @;


1.7
date	2004.05.21.14.57.40;	author morrison;	state dead;
branches;
next	1.6;

1.6
date	2004.05.10.15.30.50;	author erikg;	state Exp;
branches;
next	1.5;

1.5
date	2004.02.02.17.39.45;	author morrison;	state Exp;
branches;
next	1.4;

1.4
date	2001.08.10.20.57.06;	author butler;	state Exp;
branches
	1.4.4.1
	1.4.6.1
	1.4.12.1;
next	1.3;

1.3
date	2000.09.01.03.23.49;	author mike;	state Exp;
branches;
next	1.2;

1.2
date	2000.08.23.19.04.32;	author mike;	state Exp;
branches;
next	1.1;

1.1
date	96.10.21.19.08.08;	author jra;	state Exp;
branches;
next	;

1.4.4.1
date	2004.03.17.21.23.24;	author morrison;	state Exp;
branches;
next	;

1.4.6.1
date	2004.03.11.23.52.30;	author morrison;	state Exp;
branches;
next	;

1.4.12.1
date	2004.02.12.19.43.09;	author erikg;	state Exp;
branches;
next	1.4.12.2;

1.4.12.2
date	2004.03.15.14.08.12;	author erikg;	state Exp;
branches;
next	;


desc
@Routine to correct polysolids with wrong facing normals.
@


1.7
log
@moved to src/util/
@
text
@/*
 *			F I X _ P O L Y S O L I D . C
 *
 *  Program to fix polysolids with bad normals.
 *
 *  Author -
 *	John R. Anderson
 *  
 *  Source -
 *	The U. S. Army Research Laboratory
 *	Aberdeen Proving Ground, Maryland  21005-5066
 *  
 *  Distribution Notice -
 *	Re-distribution of this software is restricted, as described in
 *	your "Statement of Terms and Conditions for the Release of
 *	The BRL-CAD Pacakge" agreement.
 *
 *  Copyright Notice -
 *	This software is Copyright (C) 1995-2004 by the United States Army
 *	in all countries except the USA.  All rights reserved.
 */

#ifndef lint
static const char RCSid[] = "$Header: /n/xoff/cvs/brlcad/util/fix_polysolids.c,v 1.6 2004/05/10 15:30:50 erikg Exp $";
#endif

#ifdef HAVE_CONFIG_H
# include "config.h"
#endif



#include <stdio.h>
#include <math.h>
#ifdef HAVE_STRING_H
#include <string.h>
#else
#include <strings.h>
#endif

#include "machine.h"
#include "externs.h"
#include "vmath.h"
#include "nmg.h"
#include "rtgeom.h"
#include "raytrace.h"
#include "db.h"
#include "../librt/debug.h"

static int	verbose;
static char	*out_file = NULL;	/* Output filename */
static FILE	*fp_out;		/* Output file pointer */
static FILE	*fp_in;			/* input file pointer */

static struct rt_tess_tol	ttol;
static struct rt_tol		tol;

static char usage[] = "Usage: %s [-v] [-xX lvl] < brlcad_db.g > new db.g\n\
	options:\n\
		v - verbose\n\
		x - librt debug flag\n\
		X - nmg debug flag\n";


/*
 *			M A I N
 */
int
int
main(argc, argv)
int	argc;
char	*argv[];
{
	union record rec;
	struct rt_tol tol;
	int c;
	struct model *m;
	struct nmgregion *r;
	struct shell *s;
	struct nmg_ptbl faces;
	int done=0;

	/* XXX These need to be improved */
	tol.magic = RT_TOL_MAGIC;
	tol.dist = 0.005;
	tol.dist_sq = tol.dist * tol.dist;
	tol.perp = 1e-6;
	tol.para = 1 - tol.perp;

	RT_LIST_INIT( &rt_g.rtg_vlfree );	/* for vlist macros */

	/* Get command line arguments. */
	while ((c = getopt(argc, argv, "vx:X:")) != EOF) {
		switch (c) {
		case 'v':
			verbose++;
			break;
		case 'x':
			sscanf( optarg, "%x", &rt_g.debug );
			break;
		case 'X':
			sscanf( optarg, "%x", &rt_g.NMG_debug );
			break;
		default:
			fprintf(stderr, usage, argv[0]);
			exit(1);
			break;
		}
	}

	nmg_tbl( &faces , TBL_INIT , (long *)NULL );
	m = nmg_mmr();
	r = RT_LIST_FIRST( nmgregion, &m->r_hd );
	while( 1 )
	{
		struct vertex *verts[5];
		union record rec2;
		int i;

		if( done == 2 )
		{
			rec = rec2;
			done = 0;
		}
		else
			if( fread( &rec, sizeof( union record ), 1, stdin) != 1 )
				break;

		switch( rec.u_id )
		{
			case ID_FREE:
				continue;
				break;
			case ID_P_HEAD:
				rt_log( "Polysolid (%s)\n", rec.p.p_name );
				s = nmg_msv( r );
				nmg_tbl( &faces, TBL_RST, (long *)NULL );
				while( !done )
				{
					struct faceuse *fu;
					struct loopuse *lu;
					struct edgeuse *eu;
					point_t pt;

					if( fread( &rec2, sizeof( union record ), 1, stdin ) != 1 )
						done = 1;
					if( rec2.u_id != ID_P_DATA )
						done = 2;

					if( done )
						break;

					for( i=0 ; i<5 ; i++ )
						verts[i] = (struct vertex *)NULL;

					fu = nmg_cface( s, verts, rec2.q.q_count );
					lu = RT_LIST_FIRST( loopuse, &fu->lu_hd );
					eu = RT_LIST_FIRST( edgeuse, &lu->down_hd );
					for( i=0 ; i<rec2.q.q_count ; i++ )
					{
						VMOVE( pt, &rec2.q.q_verts[i] )
						nmg_vertex_gv( eu->vu_p->v_p, pt );
						eu = RT_LIST_NEXT( edgeuse, &eu->l );
					}

					if( nmg_calc_face_g( fu ) )
					{
						rt_log( "\tEliminating degenerate face\n" );
						nmg_kfu( fu );
					}
					else
						nmg_tbl( &faces, TBL_INS, (long *)fu );
				}
				nmg_rebound( m, &tol );
				(void)nmg_break_long_edges( s , &tol );
				(void)nmg_model_vertex_fuse( m, &tol );
				nmg_gluefaces( (struct faceuse **)NMG_TBL_BASEADDR( &faces) , NMG_TBL_END( &faces ), &tol );
				nmg_fix_normals( s, &tol );
				write_shell_as_polysolid( stdout, rec.p.p_name, s );
				break;
			default:
				fwrite( &rec, sizeof( union record ), 1, stdout );
				break;
		}
	}
	nmg_tbl( &faces , TBL_FREE , (long *)NULL );
}
@


1.6
log
@change conf.h to a wrapped config.h
@
text
@d24 1
a24 1
static const char RCSid[] = "$Header: /cvs/brlcad/util/fix_polysolids.c,v 1.5 2004/02/02 17:39:45 morrison Exp $";
@


1.5
log
@update copyright to include span through 2003
@
text
@d24 1
a24 1
static const char RCSid[] = "$Header: /c/CVS/brlcad/util/fix_polysolids.c,v 1.4 2001/08/10 20:57:06 butler Exp $";
d27 5
a31 1
#include "conf.h"
@


1.4
log
@Misc compiler warnings eliminated
@
text
@d19 1
a19 1
 *	This software is Copyright (C) 1995 by the United States Army
d24 1
a24 1
static const char RCSid[] = "$Header: /c/CVS/brlcad/util/fix_polysolids.c,v 1.3 2000/09/01 03:23:49 mike Exp $";
@


1.4.4.1
log
@sync branch with HEAD
@
text
@d19 1
a19 1
 *	This software is Copyright (C) 1995-2004 by the United States Army
d24 1
a24 1
static const char RCSid[] = "$Header$";
@


1.4.6.1
log
@sync to HEAD...
@
text
@d19 1
a19 1
 *	This software is Copyright (C) 1995-2004 by the United States Army
d24 1
a24 1
static const char RCSid[] = "$Header: /n/cad/c/CVS/brlcad/util/fix_polysolids.c,v 1.5 2004/02/02 17:39:45 morrison Exp $";
@


1.4.12.1
log
@merge from HEAD
@
text
@d19 1
a19 1
 *	This software is Copyright (C) 1995-2004 by the United States Army
d24 1
a24 1
static const char RCSid[] = "$Header: /c/CVS/brlcad/util/fix_polysolids.c,v 1.5 2004/02/02 17:39:45 morrison Exp $";
@


1.4.12.2
log
@merge from head
@
text
@d24 1
a24 1
static const char RCSid[] = "$Header: /c/CVS/brlcad/util/fix_polysolids.c,v 1.4.12.1 2004/02/12 19:43:09 erikg Exp $";
@


1.3
log
@
Lint fix
@
text
@d24 1
a24 1
static const char RCSid[] = "$Header: /c/CVS/brlcad/util/fix_polysolids.c,v 1.2 2000/08/23 19:04:32 mike Exp $";
d31 1
a31 1
#ifdef USE_STRING_H
@


1.2
log
@
const RCSid
@
text
@d24 1
a24 1
static const char RCSid[] = "$Header: /c/CVS/brlcad/util/fix_polysolids.c,v 1.1 1996/10/21 19:08:08 jra Exp $";
d64 1
@


1.1
log
@Initial revision
@
text
@d24 1
a24 1
static char RCSid[] = "$Header: /m/cad/conv/RCS/g-tankill.c,v 11.5 1995/04/03 19:48:38 jra Exp $";
@

