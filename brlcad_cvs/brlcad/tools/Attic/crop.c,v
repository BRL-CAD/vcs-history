head	11.7;
access;
symbols
	ansi-20040405-merged:11.4.2.1
	postmerge-20040405-ansi:11.5
	premerge-20040404-ansi:11.4
	postmerge-autoconf:11.4
	autoconf-freeze:11.4
	premerge-autoconf:11.4
	postmerge-20040315-windows:11.4
	premerge-20040315-windows:11.4
	windows-20040315-freeze:11.4
	autoconf-20031203:11.4
	autoconf-20031202:11.4
	autoconf-branch:11.4.0.10
	phong-branch:11.4.0.8
	photonmap-branch:11.4.0.6
	rel-6-1-DP:11.4
	windows-branch:11.4.0.4
	rel-6-0-2:11.2
	ansi-branch:11.4.0.2
	rel-6-0-1-branch:11.2.0.2
	hartley-6-0-post:11.3
	hartley-6-0-pre:11.2
	rel-6-0-1:11.2
	rel-6-0:11.2
	rel-5-4:11.1
	offsite-5-3-pre:11.2
	rel-5-3:11.1
	rel-5-2:11.1
	rel-5-1-branch:11.1.0.2
	rel-5-1:11.1
	rel-5-0:11.1
	rel-5-0-beta:11.1
	rel-4-5:11.1
	ctj-4-5-post:11.1
	ctj-4-5-pre:11.1
	rel-4-4:11.1
	rel-4-0:10.1;
locks; strict;
comment	@ * @;


11.7
date	2004.05.21.16.38.44;	author morrison;	state dead;
branches;
next	11.6;

11.6
date	2004.05.10.15.30.50;	author erikg;	state Exp;
branches;
next	11.5;

11.5
date	2004.04.05.05.46.00;	author morrison;	state Exp;
branches;
next	11.4;

11.4
date	2002.08.20.17.08.48;	author jra;	state Exp;
branches
	11.4.2.1;
next	11.3;

11.3
date	2002.08.15.20.55.59;	author hartley;	state Exp;
branches;
next	11.2;

11.2
date	2000.08.24.22.46.17;	author mike;	state Exp;
branches;
next	11.1;

11.1
date	95.01.04.10.20.27;	author mike;	state Rel4_4;
branches;
next	10.3;

10.3
date	94.08.11.16.52.06;	author gdurf;	state Exp;
branches;
next	10.2;

10.2
date	94.08.11.16.40.09;	author gdurf;	state Exp;
branches;
next	10.1;

10.1
date	91.10.12.06.51.56;	author mike;	state Rel4_0;
branches;
next	1.1;

1.1
date	91.01.03.20.45.14;	author butler;	state Exp;
branches;
next	;

11.4.2.1
date	2002.09.19.18.02.27;	author morrison;	state Exp;
branches;
next	;


desc
@dist
@


11.7
log
@moved to src/tools/
@
text
@/*
 * This software is copyrighted as noted below.  It may be freely copied,
 * modified, and redistributed, provided that the copyright notice is 
 * preserved on all copies.
 * 
 * There is no warranty or other guarantee of fitness for this software,
 * it is provided solely "as is".  Bug reports or fixes may be sent
 * to the author, who may or may not act on them as he desires.
 *
 * You may not include this software in a program or other software product
 * without supplying the source, or without informing the end-user that the 
 * source is available for no extra charge.
 *
 * If you modify this software, you should include a notice giving the
 * name of the person performing the modification, the date of modification,
 * and the reason for such modification.
 */
/* 
 * crop.c - Crop an image to the given size.
 * 
 * Author:	Rod Bogart & John W. Peterson
 * 		Computer Science Dept. 
 * 		University of Utah
 * Date:	Mon Jun 23 1986
 * Copyright (c) 1986, University of Utah
 * 
 */
#ifndef lint
static const char rcs_ident[] = "$Header: /n/xoff/cvs/brlcad/tools/crop.c,v 11.6 2004/05/10 15:30:50 erikg Exp $";
#endif

#ifdef HAVE_CONFIG_H
# include "config.h"
#endif



#include <stdio.h>

#include "machine.h"
#include "externs.h"
#include "rle.h"

extern void rle_box(rle_hdr *the_hdr, int *xminp, int *xmaxp, int *yminp, int *ymaxp);
int pos_box_vals(int x1, int y1, int x2, int y2);

int
main(int argc, char **argv)
{
    rle_pixel **scanline, **rows, **outrows;
    int xlen, i, j;
    int xmin = -1, ymin = -1, xmax = -1, ymax = -1;
    char *infilename = NULL, *out_fname = NULL;
    FILE *outfile = stdout;
    int oflag = 0, bflag = 0, bottom_row;
    rle_hdr in_hdr, out_hdr;
    int rle_cnt, rle_err;
    long start;

    if (scanargs( argc, argv,
		  "% b%- xmin%d ymin%d xmax%d ymax%d o%-outfile!s infile%s",
		  &bflag, &xmin, &ymin, &xmax, &ymax, &oflag,  &out_fname,
		  &infilename ) == 0)
    {
	exit(-1);
    }

    in_hdr.rle_file = rle_open_f( cmd_name( argv ), infilename, "r" );
    for ( rle_cnt = 0; ; rle_cnt++ )
    {
	start = ftell( in_hdr.rle_file );
	if ( (rle_err = rle_get_setup( &in_hdr )) != RLE_SUCCESS )
	    break;

	out_hdr = in_hdr;
	rle_addhist( argv, &in_hdr, &out_hdr );

	if ( rle_cnt == 0 )
	    outfile = rle_open_f( cmd_name( argv ), out_fname, "w" );
	out_hdr.rle_file = outfile;

	/* If bflag, then pre-scan file to get bounding box. */
	if (bflag != 0)
	{
	    if (xmin == -1 && start >= 0)
	    {
		/* Common code with rlebox program. */
		rle_box( &in_hdr, &xmin, &xmax, &ymin, &ymax );

		/* Rewind and start over. */
		fseek( in_hdr.rle_file, start, 0 );
		rle_get_setup( &in_hdr );	/* Should work fine this time. */
	    }
	    else
	    {
		/* error message and exit: -b flag and box values or piped input */
		if (xmin != -1) 
		    fprintf( stderr,
			     "%s: You cannot specify the -b flag and box values together\n",
			     cmd_name( argv ) );
		else
		    fprintf( stderr,
			     "%s: No piped input allowed with the -b flag\n",
			     cmd_name( argv ) );
		exit(-1);
	    }
	}
	else if ( pos_box_vals( xmin, ymin, xmax, ymax ) != 0 )
	{
	    fprintf( stderr,
		     "%s: You must specify either all the box coordinates or the -b flag\n",
		     cmd_name( argv ) );
	    exit(-1);
	}
 
	xlen = xmax - xmin + 1;

	if ( (xmin > xmax) || (ymin > ymax) )
	{
	    fprintf( stderr, "%s: Illegal size: %d, %d to %d, %d\n",
		     cmd_name( argv ), xmin, ymin, xmax, ymax );
	    exit(-1);
	}

	/* should check for disjoint regions */

	out_hdr.xmin = xmin;
	out_hdr.ymin = ymin;
	out_hdr.xmax = xmax;
	out_hdr.ymax = ymax;

	rle_put_setup( &out_hdr );

	if (out_hdr.xmax > in_hdr.xmax)
	{
	    if (rle_row_alloc( &out_hdr, &scanline ))
		fprintf( stderr, "%s: Ran out of malloc space\n",
			 cmd_name( argv ) );
	}
	else
	{
	    if (rle_row_alloc( &in_hdr, &scanline ))
		fprintf( stderr, "%s: Ran out of malloc space\n",
			 cmd_name( argv ) );
	}

	if (!(rows = (rle_pixel **)
	      malloc((in_hdr.ncolors + in_hdr.alpha)
		     * sizeof( rle_pixel * ))))
	    fprintf( stderr, "%s: Ran out of malloc space\n",
		     cmd_name( argv ) );

	if (!(outrows = (rle_pixel **)
	      malloc((in_hdr.ncolors + in_hdr.alpha)
		     * sizeof( rle_pixel * ))))
	    fprintf( stderr, "%s: Ran out of malloc space\n",
		     cmd_name( argv ) );

	if ( in_hdr.alpha )
	{
	    rows++;		/* So alpha is rows[-1] */
	    outrows++;
	}
 
	for( i = -in_hdr.alpha; i < in_hdr.ncolors; i++ )
	    rows[i] = scanline[i];

	for( i = -in_hdr.alpha; i < in_hdr.ncolors; i++ )
	    outrows[i] = &scanline[i][xmin];
    
	bottom_row = in_hdr.ymin;
	if (in_hdr.ymin > out_hdr.ymin)
	{
	    /* Output blank scanlines if crop region is larger than data */
	    rle_skiprow(&out_hdr, in_hdr.ymin - out_hdr.ymin);
	    bottom_row = in_hdr.ymin;
	}
	else
	    if (in_hdr.ymin < out_hdr.ymin)
	    {
		/* Read past extra lower scanlines */
		for (i = in_hdr.ymin; i < out_hdr.ymin; i++)
		    rle_getrow(&in_hdr, rows );
		bottom_row = out_hdr.ymin;
	    }

	/* Read in image */
	for (j = bottom_row; j <= out_hdr.ymax; j++)
	{
	    rle_getrow(&in_hdr, rows );

	    rle_putrow( outrows, xlen, &out_hdr );
	}
	rle_puteof( &out_hdr );

	/* Skip extra upper scanlines. */
	while ( rle_getskip( &in_hdr ) != 32768 )
	    ;

	/* Clean up for next time around. */
	rle_row_free( (out_hdr.xmax > in_hdr.xmax) ? &out_hdr : &in_hdr,
		      scanline );
	free( rows - in_hdr.alpha );
	free( outrows - in_hdr.alpha );

	if ( bflag )
	    xmin = xmax = ymin = ymax = -1;
    }

    /* Check for an error.  EOF or EMPTY is ok if at least one image
     * has been read.  Otherwise, print an error message.
     */
    if ( rle_cnt == 0 || (rle_err != RLE_EOF && rle_err != RLE_EMPTY) )
	rle_get_error( rle_err, cmd_name( argv ), infilename );


    exit( 0 );
}

/* Return 0 if all parameters >= 0, else -1. */
int
pos_box_vals(int x1, int y1, int x2, int y2)
{
  if ((x1 < 0) || (y1 < 0) || (x2 < 0) || (y2 < 0))
    return -1;
  else
    return 0;
}
@


11.6
log
@change conf.h to a wrapped config.h
@
text
@d29 1
a29 1
static const char rcs_ident[] = "$Header: /cvs/brlcad/tools/crop.c,v 11.5 2004/04/05 05:46:00 morrison Exp $";
@


11.5
log
@merge of ansi-6-0-branch into head
@
text
@d29 1
a29 1
static const char rcs_ident[] = "$Header$";
d32 5
a36 1
#include "conf.h"
@


11.4
log
@Restoration of entire source tree to Pre-Hartley state
@
text
@d29 1
a29 1
static const char rcs_ident[] = "$Header: /c/CVS/brlcad/tools/crop.c,v 11.2 2000/08/24 22:46:17 mike Exp $";
d40 2
a41 2
extern void rle_box();
int pos_box_vals();
d44 1
a44 3
main(argc, argv)
int	argc;
char	*argv[];
d218 1
a218 2
pos_box_vals(x1, y1, x2, y2)
int x1, y1, x2, y2;
@


11.4.2.1
log
@Initial ANSIfication
@
text
@d29 1
a29 1
static const char rcs_ident[] = "$Header: /c/CVS/brlcad/tools/crop.c,v 11.4 2002/08/20 17:08:48 jra Exp $";
d40 2
a41 2
extern void rle_box(rle_hdr *the_hdr, int *xminp, int *xmaxp, int *yminp, int *ymaxp);
int pos_box_vals(int x1, int y1, int x2, int y2);
d44 3
a46 1
main(int argc, char **argv)
d220 2
a221 1
pos_box_vals(int x1, int y1, int x2, int y2)
@


11.3
log
@Converted from K&R to ANSI C - RFH
@
text
@d40 2
a41 2
extern void rle_box(rle_hdr *the_hdr, int *xminp, int *xmaxp, int *yminp, int *ymaxp);
int pos_box_vals(int x1, int y1, int x2, int y2);
d44 3
a46 1
main(int argc, char **argv)
d220 2
a221 1
pos_box_vals(int x1, int y1, int x2, int y2)
@


11.2
log
@
lint
@
text
@d29 1
a29 1
static const char rcs_ident[] = "$Header: /c/CVS/brlcad/tools/crop.c,v 11.1 1995/01/04 10:20:27 mike Rel4_4 $";
d40 2
a41 2
extern void rle_box();
int pos_box_vals();
d44 1
a44 3
main(argc, argv)
int	argc;
char	*argv[];
d218 1
a218 2
pos_box_vals(x1, y1, x2, y2)
int x1, y1, x2, y2;
@


11.1
log
@Release_4.4
@
text
@d29 1
a29 1
static char rcs_ident[] = "$Header: /m/cad/tools/RCS/crop.c,v 10.3 94/08/11 16:52:06 gdurf Exp $";
d43 1
a43 1
void
@


10.3
log
@Fix typo
@
text
@d29 1
a29 1
static char rcs_ident[] = "$Header: /m/cad/tools/RCS/crop.c,v 10.2 1994/08/11 16:40:09 gdurf Exp gdurf $";
@


10.2
log
@Altered #defines and #includes to conform to BRL-CAD standards
@
text
@d29 1
a29 1
static char rcs_ident[] = "$Header: /m/cad/tools/RCS/crop.c,v 10.1 1991/10/12 06:51:56 mike Rel4_0 gdurf $";
d38 1
a38 1
#include "<rle.h"
@


10.1
log
@Release_4.0
@
text
@d29 1
a29 1
static char rcs_ident[] = "$Header: /m/cad/tools/RCS/crop.c,v 1.1 91/01/03 20:45:14 butler Exp $";
d32 2
a34 11
#include <rle.h>
#ifdef USE_STDLIB_H
#include <stdlib.h>
#else

#ifdef VOID_STAR
extern void *malloc();
#else
extern char *malloc();
#endif
extern void free();
d36 3
a38 1
#endif /* USE_STDLIB_H */
@


1.1
log
@Initial revision
@
text
@d29 1
a29 1
static char rcs_ident[] = "$Header: /usr/users/spencer/src/urt/tools/RCS/crop.c,v 3.0 90/08/03 15:21:45 spencer Exp $";
@
