head	11.7;
access;
symbols
	ansi-20040405-merged:11.4.2.1
	postmerge-20040405-ansi:11.5
	premerge-20040404-ansi:11.4
	postmerge-autoconf:11.4
	autoconf-freeze:11.4
	premerge-autoconf:11.4
	postmerge-20040315-windows:11.4
	premerge-20040315-windows:11.4
	windows-20040315-freeze:11.4
	autoconf-20031203:11.4
	autoconf-20031202:11.4
	autoconf-branch:11.4.0.10
	phong-branch:11.4.0.8
	photonmap-branch:11.4.0.6
	rel-6-1-DP:11.4
	windows-branch:11.4.0.4
	rel-6-0-2:11.2
	ansi-branch:11.4.0.2
	rel-6-0-1-branch:11.2.0.2
	hartley-6-0-post:11.3
	hartley-6-0-pre:11.2
	rel-6-0-1:11.2
	rel-6-0:11.2
	rel-5-4:11.1
	offsite-5-3-pre:11.2
	rel-5-3:11.1
	rel-5-2:11.1
	rel-5-1-branch:11.1.0.2
	rel-5-1:11.1
	rel-5-0:11.1
	rel-5-0-beta:11.1
	rel-4-5:11.1
	ctj-4-5-post:11.1
	ctj-4-5-pre:11.1
	rel-4-4:11.1
	rel-4-0:10.1;
locks; strict;
comment	@ * @;


11.7
date	2004.05.21.16.39.03;	author morrison;	state dead;
branches;
next	11.6;

11.6
date	2004.05.10.15.30.50;	author erikg;	state Exp;
branches;
next	11.5;

11.5
date	2004.04.05.05.46.01;	author morrison;	state Exp;
branches;
next	11.4;

11.4
date	2002.08.20.17.08.51;	author jra;	state Exp;
branches
	11.4.2.1;
next	11.3;

11.3
date	2002.08.15.20.56.03;	author hartley;	state Exp;
branches;
next	11.2;

11.2
date	2000.08.24.22.46.25;	author mike;	state Exp;
branches;
next	11.1;

11.1
date	95.01.04.10.21.40;	author mike;	state Rel4_4;
branches;
next	10.2;

10.2
date	94.08.11.20.09.27;	author gdurf;	state Exp;
branches;
next	10.1;

10.1
date	91.10.12.06.53.14;	author mike;	state Rel4_0;
branches;
next	1.1;

1.1
date	91.01.24.20.34.13;	author butler;	state Exp;
branches;
next	;

11.4.2.1
date	2002.09.19.18.02.32;	author morrison;	state Exp;
branches;
next	;


desc
@Original distribution of Rel. 3 patchlevel 2
@


11.7
log
@moved to src/tools/
@
text
@/*
 * This software is copyrighted as noted below.  It may be freely copied,
 * modified, and redistributed, provided that the copyright notice is 
 * preserved on all copies.
 * 
 * There is no warranty or other guarantee of fitness for this software,
 * it is provided solely "as is".  Bug reports or fixes may be sent
 * to the author, who may or may not act on them as he desires.
 *
 * You may not include this software in a program or other software product
 * without supplying the source, or without informing the end-user that the 
 * source is available for no extra charge.
 *
 * If you modify this software, you should include a notice giving the
 * name of the person performing the modification, the date of modification,
 * and the reason for such modification.
 */
/* 
 * wasatchrle.c - Convert Wasatch Paintbox files into RLE
 * 
 * Author:	John W. Peterson
 * 		Computer Science Dept.
 * 		University of Utah
 * Date:	Tue Dec 15 1987
 * Copyright (c) 1987, University of Utah
 *
 * Thanks to Mike Ware of Wasatch for providing the format information.
 */

#ifdef HAVE_CONFIG_H
# include "config.h"
#endif



#include <stdio.h>
#ifdef USE_STRING_H
#include <string.h>
#else
#include <strings.h>
#endif
#include <ctype.h>
#include <errno.h>

#include "machine.h"
#include "externs.h"			/* For stdlib stuff */
#include "rle.h"

/* "short" in our world is 16 bits.  Beware of swyte-bopping. */

struct was_head {
    short x1, y1;		/* First corner of viewport */
    short x2, y2;		/* Second corner of viewport */
    short top, bottom;		/* "Reserved" */
    short unused[19];
    char  reserved[14];
} was_head;

short	rlemap[3][256];		/* RLE version of the color map */
rle_pixel rgb[3];		/* For reading in the color map */

struct was_op {			/* A wasatch "opcode" */
    rle_pixel count, data;
} was_op;

int
main(int argc, char **argv)
{
    FILE       *open_with_ext(char *basename, char *ext);
    int 	oflag = 0;
    char       *out_name = NULL;
    char       *was_basename;
    FILE       *lut_file, *rlc_file;	/* Wasatch input files */
    rle_pixel **row;
    rle_pixel  *pxlptr;
    int 	i, xpos;

    if (scanargs( argc, argv, "% o%-outfile!s basename!s",
		  &oflag, &out_name, &was_basename ) == 0)
	exit(-1);

    lut_file = open_with_ext( was_basename, ".lut" );
    rlc_file = open_with_ext( was_basename, ".rlc" );

    rle_dflt_hdr.rle_file = rle_open_f( "wasatchrle", out_name, "w" );

    fread( &was_head, sizeof( was_head ), 1, rlc_file );

    /*
     * The spec provided by Wasatch is not clear on the meaning or any
     * intended order of the "viewport corners".  Also, look out for
     * BYTE SWAPPING.
     */
    rle_dflt_hdr.xmin = was_head.x1;
    rle_dflt_hdr.ymin = was_head.y1;
    rle_dflt_hdr.xmax = was_head.x2;
    rle_dflt_hdr.ymax = was_head.y2;

    rle_dflt_hdr.ncolors = 1;
    rle_dflt_hdr.alpha = 0;	/* What a shame... */
    for (i = 1; i < rle_dflt_hdr.ncolors; i++)
	RLE_CLR_BIT( rle_dflt_hdr, i );
    rle_dflt_hdr.ncmap = 3;
    rle_dflt_hdr.cmaplen = 8; /* == 256 entries */
    rle_dflt_hdr.cmap = (rle_map *) rlemap;

    /* Grab the map. */

    for (i = 0; i < 256; i++)
    {
	fread( rgb, sizeof( rgb ), 1, lut_file );
	rlemap[RLE_RED][i] = ( (int)rgb[RLE_RED] ) << 8;
	rlemap[RLE_GREEN][i] = ( (int)rgb[RLE_GREEN] ) << 8;
	rlemap[RLE_BLUE][i] = ( (int)rgb[RLE_BLUE] ) << 8;
    }

    rle_addhist( argv, (rle_hdr *)NULL, &rle_dflt_hdr );
    rle_put_setup( &rle_dflt_hdr );
    rle_dflt_hdr.xmax -= rle_dflt_hdr.xmin;
    rle_dflt_hdr.xmin = 0;

    if (rle_row_alloc( &rle_dflt_hdr, &row ))
    {
	fprintf( stderr, "wasacthrle: malloc failed\n" );
	exit(-2);
    }

    xpos = 0;
    pxlptr = row[0];
    was_op.count = 0;		/* Haven't read anything yet. */

    do {
	while (was_op.count--)
	{
	    if (xpos > rle_dflt_hdr.xmax) /* Flush scanline */
	    {
		rle_putrow( row, (rle_dflt_hdr.xmax + 1), &rle_dflt_hdr );
		xpos = 0;
		pxlptr = row[0];
	    }
	    *pxlptr++ = was_op.data;
	    xpos++;
	}
	fread( &was_op, sizeof( was_op ), 1, rlc_file );
    } while( was_op.count );

    if (xpos)
	rle_putrow( row, (rle_dflt_hdr.xmax + 1), &rle_dflt_hdr );
    rle_puteof( &rle_dflt_hdr );
    exit(0);
}

/*****************************************************************
 * TAG( open_with_ext )
 * 
 * Open a file "basename" with extension (suffix) "ext".  Tries "ext"
 * with both lower and upper case (should be called with "ext" in
 * lower case).  If both opens fail, it exits the program.
 */

FILE *
open_with_ext(char *basename, char *ext)
{
    char file_name[255];
    char ext_name[10];
    char * cptr;
    FILE * f;

    strcpy( ext_name, ext );
    strcpy( file_name, basename );
    strcat( file_name, ext_name );

    if (! (f = fopen( file_name, "r" )))
    {
	if (errno == ENOENT)	/* Not found, try upper case */
	{
	    strcpy( file_name, basename );
	    cptr = ext_name;
	    for (; *cptr; cptr++ )
		*cptr = toupper( *cptr );
	    strcat( file_name, ext_name );
	    f = fopen( file_name, "r" );
	}
    }

    if (! f)			/* fopen failed */
    {
	perror( file_name );
	exit( -1 );
    }
    return( f );
}
    
@


11.6
log
@change conf.h to a wrapped config.h
@
text
@@


11.5
log
@merge of ansi-6-0-branch into head
@
text
@d30 5
a34 1
#include "conf.h"
@


11.4
log
@Restoration of entire source tree to Pre-Hartley state
@
text
@d63 1
a63 3
main(argc, argv)
int argc;
char **argv;
d65 1
a65 1
    FILE       *open_with_ext();
d158 1
a158 3
open_with_ext( basename, ext )
char * basename;
char * ext;
@


11.4.2.1
log
@Initial ANSIfication
@
text
@d63 3
a65 1
main(int argc, char **argv)
d67 1
a67 1
    FILE       *open_with_ext(char *basename, char *ext);
d160 3
a162 1
open_with_ext(char *basename, char *ext)
@


11.3
log
@Converted from K&R to ANSI C - RFH
@
text
@d63 3
a65 1
main(int argc, char **argv)
d67 1
a67 1
    FILE       *open_with_ext(char *basename, char *ext);
d160 3
a162 1
open_with_ext(char *basename, char *ext)
@


11.2
log
@
lint
@
text
@d63 1
a63 3
main(argc, argv)
int argc;
char **argv;
d65 1
a65 1
    FILE       *open_with_ext();
d158 1
a158 3
open_with_ext( basename, ext )
char * basename;
char * ext;
@


11.1
log
@Release_4.4
@
text
@d62 1
a62 1
void
@


10.2
log
@Altered #defines and #includes to conform to BRL-CAD standards
@
text
@@


10.1
log
@Release_4.0
@
text
@d30 2
a32 7
#include <ctype.h>
#include <errno.h>
#include "rle.h"
#ifdef USE_STDLIB_H
#include <stdlib.h>
#else

d38 2
d41 3
a43 3
#endif /* USE_STDLIB_H */

extern int errno;
@


1.1
log
@Initial revision
@
text
@@
